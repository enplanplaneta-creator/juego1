<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caza-bulos ambientales Â· Juego</title>
  <style>
    /* ===========
       Reset local y variables
       =========== */
    #game-root, #game-root * { box-sizing: border-box; }
    #game-root {
      --bg0: #bfe3ff;
      --bg1: #e9f5ff;
      --ink: #0b243b;
      --ink-soft: #254a6a;
      --panel: rgba(255,255,255,.9);
      --accent: #0ea5e9;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --shadow: 0 6px 24px rgba(0,0,0,.15);
      position: relative;
      width: 100%;
      min-height: 100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      color: var(--ink);
      overflow: hidden; /* evita scroll en el bloque */
      line-height: 1.3;
    }

    /* ===========
       Escena
       =========== */
    #game-root .game-area {
      position: relative;
      width: 100%;
      height: 100vh;
      background: radial-gradient(120% 100% at 50% 0%, var(--bg1) 0%, var(--bg0) 50%, #a7d8ff 100%);
      overflow: hidden;
      touch-action: none;
      user-select: none;
    }

    /* HUD superior */
    #game-root .hud {
      position: absolute;
      inset: 12px 12px auto 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      z-index: 30;
      background: rgba(255,255,255,.6);
      backdrop-filter: blur(6px);
      border-radius: 14px;
      padding: 8px 10px;
      box-shadow: var(--shadow);
    }
    #game-root .hud .counter {
      font-weight: 700;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(255,255,255,.9);
    }
    #game-root .btn {
      appearance: none;
      border: 0;
      border-radius: 12px;
      background: var(--accent);
      color: #fff;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .05s ease, opacity .2s ease;
      box-shadow: var(--shadow);
    }
    #game-root .btn:active { transform: translateY(1px) scale(0.99); }
    #game-root .btn.secondary { background: var(--accent-2); }
    #game-root .btn.danger { background: var(--danger); }

    /* ===========
       Protagonista
       =========== */
    #game-root .player {
      position: absolute;
      width: 56px; height: 56px;
      /* Fallback visible si JS no carga: */
      left: 50%; top: 62%;
      transform: translate(-50%, -50%);
      will-change: transform;
      z-index: 10;
      pointer-events: none;
    }
    #game-root .player svg { display: block; width: 100%; height: 100%; }
    /* animaciÃ³n ligera del brazo/red */
    @keyframes sway {
      0%,100% { transform: rotate(-6deg); }
      50% { transform: rotate(6deg); }
    }
    #game-root .player .arm { transform-origin: 36px 16px; animation: sway 1.2s ease-in-out infinite; }

    /* ===========
       Mariposas
       =========== */
    #game-root .butterfly {
      position: absolute;
      width: 44px; height: 36px;
      transform: translate(-50%,-50%);
      will-change: transform;
      z-index: 5;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
    }
    #game-root .butterfly svg { width: 100%; height: 100%; display: block; }
    @keyframes flap {
      0%, 100% { transform: rotate(4deg) scale(1.02); }
      50% { transform: rotate(-6deg) scale(0.98); }
    }
    #game-root .butterfly .wL { transform-origin: right center; animation: flap .6s ease-in-out infinite; }
    #game-root .butterfly .wR { transform-origin: left center; animation: flap .6s ease-in-out infinite reverse; }

    /* ===========
       Modal y fin
       =========== */
    #game-root .modal,
    #game-root .end-screen {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      z-index: 50;
    }
    #game-root .hidden { display: none !important; }
    #game-root .overlay {
      position: absolute;
      inset: 0;
      background: rgba(4, 21, 39, .45);
      backdrop-filter: blur(2px);
    }
    #game-root .dialog,
    #game-root .panel {
      position: relative;
      width: min(92vw, 840px);
      max-height: min(86vh, 720px);
      overflow: auto;
      background: var(--panel);
      border-radius: 16px;
      padding: 18px 18px 14px 18px;
      box-shadow: var(--shadow);
    }
    #game-root .dialog h2 { margin: 0 0 8px; font-size: clamp(1.1rem, 2.4vw, 1.5rem); }
    #game-root .dialog p { margin: 6px 0 0; font-size: clamp(.95rem, 2vw, 1.05rem); }
    #game-root .dialog .sources {
      margin-top: 10px;
      font-size: .95rem;
      color: var(--ink-soft);
    }
    #game-root .dialog .actions {
      display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px;
    }
    #game-root .close-x {
      position: absolute;
      top: 8px; right: 8px;
      width: 36px; height: 36px;
      border-radius: 10px;
      border: 0;
      background: #fff;
      cursor: pointer;
      box-shadow: var(--shadow);
      font-size: 20px;
      line-height: 1;
    }
    #game-root .panel h2 { margin: 0 0 8px; font-size: clamp(1.2rem, 2.8vw, 1.8rem); }
    #game-root .panel p { margin: 10px 0 16px; }

    /* ===========
       Controles tÃ¡ctiles
       =========== */
    #game-root .touch-ui {
      position: absolute;
      inset: auto 12px 12px 12px;
      display: flex;
      align-items: flex-end;
      gap: 12px;
      z-index: 40;
      pointer-events: none;
    }
    .joystick {
      pointer-events: auto;
      position: relative;
      width: 112px; height: 112px;
      border-radius: 50%;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(6px);
      box-shadow: var(--shadow);
      touch-action: none;
    }
    .joystick .stick {
      position: absolute;
      left: 50%; top: 50%;
      width: 56px; height: 56px;
      transform: translate(-50%,-50%);
      border-radius: 50%;
      background: rgba(255,255,255,.95);
      border: 2px solid rgba(0,0,0,.08);
      box-shadow: var(--shadow);
    }
    .dpad {
      pointer-events: auto;
      display: grid;
      grid-template:
        " . up  . " 40px
        "left . right" 40px
        " . down . " 40px / 40px 40px 40px;
      gap: 6px;
      background: rgba(255,255,255,.55);
      padding: 8px;
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
    .dpad button {
      width: 40px; height: 40px;
      border-radius: 10px;
      border: 0;
      background: rgba(255,255,255,.95);
      font-weight: 900;
      box-shadow: var(--shadow);
      cursor: pointer;
    }
    .dpad .up   { grid-area: up; }
    .dpad .down { grid-area: down; }
    .dpad .left { grid-area: left; }
    .dpad .right{ grid-area: right; }

    @media (min-width: 900px) {
      #game-root .touch-ui { opacity: .85; }
    }
  </style>
</head>
<body>
  <div id="game-root" tabindex="0" aria-label="Juego caza-bulos ambientales" role="application">
    <div class="game-area" id="gameArea" aria-label="Ãrea de juego">
      <!-- HUD -->
      <div class="hud" aria-live="polite">
        <div class="counter">Bulos vistos: <span id="seenCount">0</span>/10</div>
        <button class="btn" id="btnRestart" aria-label="Reiniciar partida">Reiniciar</button>
      </div>

      <!-- Protagonista -->
      <div class="player" id="player" role="img" aria-label="Protagonista con cazamariposas">
        <!-- SVG del personaje -->
        <svg viewBox="0 0 56 56" aria-hidden="true">
          <!-- cabeza / cuerpo -->
          <circle cx="20" cy="14" r="8" fill="#ffd38e" />
          <rect x="12" y="22" width="16" height="18" rx="6" fill="#2563eb"/>
          <rect x="10" y="40" width="10" height="12" rx="3" fill="#0ea5e9"/>
          <rect x="20" y="40" width="10" height="12" rx="3" fill="#0ea5e9"/>
          <!-- brazo + red -->
          <g class="arm">
            <rect x="24" y="24" width="18" height="6" rx="3" fill="#ffd38e"/>
            <rect x="38" y="18" width="3" height="20" rx="1.5" fill="#8b5e3c"/>
            <ellipse cx="45" cy="14" rx="9" ry="7" fill="#fff" stroke="#7aa2c8" stroke-width="2"/>
            <ellipse cx="45" cy="14" rx="7" ry="5" fill="none" stroke="#7aa2c8" stroke-width="1.2" stroke-dasharray="2 2"/>
          </g>
        </svg>
      </div>

      <!-- Contenedor de mariposas -->
      <div id="butterflies" aria-label="Mariposas"></div>

      <!-- Controles tÃ¡ctiles -->
      <div class="touch-ui" aria-hidden="false">
        <div class="joystick" id="joystick" aria-label="Joystick tÃ¡ctil">
          <div class="stick" id="stick"></div>
        </div>
        <div class="dpad" aria-label="Botones flecha tÃ¡ctiles">
          <button class="up"    data-dir="up"    aria-label="Arriba">â–²</button>
          <button class="left"  data-dir="left"  aria-label="Izquierda">â—€</button>
          <button class="right" data-dir="right" aria-label="Derecha">â–¶</button>
          <button class="down"  data-dir="down"  aria-label="Abajo">â–¼</button>
        </div>
      </div>
    </div>

    <!-- Modal de bulo -->
    <div class="modal hidden" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="overlay" id="overlay" tabindex="-1"></div>
      <div class="dialog" role="document">
        <button class="close-x" id="closeX" aria-label="Cerrar">Ã—</button>
        <h2 id="modalTitle">TÃ­tulo</h2>
        <p id="modalText">Texto</p>
        <p class="sources" id="modalSources"><strong>Fuentes:</strong> â€”</p>
        <div class="actions">
          <button class="btn secondary" id="modalOk" autofocus>Cerrar (Esc)</button>
        </div>
      </div>
    </div>

    <!-- Pantalla final -->
    <div class="end-screen hidden" id="endScreen" role="dialog" aria-modal="true" aria-labelledby="endTitle">
      <div class="overlay"></div>
      <div class="panel">
        <h2 id="endTitle">Â¡Enhorabuena! ðŸ¦‹</h2>
        <p>Has cazado los 10 bulos. Â¿Otra partida?</p>
        <button class="btn" id="playAgain">Volver a jugar</button>
      </div>
    </div>
  </div>

  <script>
    // ===========================
    // Datos de bulos
    // ===========================
    const BULOS = [
      { id: 1,  titulo: "El clima siempre ha cambiado â€” esto no es diferente",
        texto: "Aunque el clima de la Tierra ha variado en el pasado, el ritmo actual de calentamiento es mucho mÃ¡s rÃ¡pido que cualquier variaciÃ³n natural en millones de aÃ±os.",
        fuentes: ["Covering Climate Now", "#ThinkLandscape", "Covering Climate Now"] },
      { id: 2,  titulo: "EstÃ¡ haciendo frÃ­o hoy, Â¿cÃ³mo puede haber calentamiento global?",
        texto: "Esta confusiÃ³n surge de mezclar clima (corto plazo, local) con tiempo atmosfÃ©rico. Aunque haya dÃ­as frÃ­os, la tendencia global sigue siendo de aumento de temperatura.",
        fuentes: ["UNEP - UN Environment Programme", "Greenpeace"] },
      { id: 3,  titulo: "Los cientÃ­ficos no estÃ¡n de acuerdo sobre el cambio climÃ¡tico",
        texto: "La evidencia cientÃ­fica es clara: mÃ¡s del 97â€“99 % de los estudios revisados concluyen que el cambio climÃ¡tico es consecuencia de la actividad humana.",
        fuentes: ["#ThinkLandscape"] },
      { id: 4,  titulo: "El COâ‚‚ es necesario para las plantas, no puede ser daÃ±ino",
        texto: "Es cierto que las plantas necesitan COâ‚‚, pero la cantidad adicional liberada hoy en dÃ­a sobrepasa la capacidad de absorciÃ³n natural, especialmente con la deforestaciÃ³n.",
        fuentes: ["National Grid"] },
      { id: 5,  titulo: "No ha calentado desde 1998 (o hubo una pausa)",
        texto: "Durante 1998â€“2012 se observÃ³ una moderaciÃ³n en el aumento de temperatura superficial en algunos registros, pero estudios posteriores demuestran que ese aparente 'hiato' fue artefacto de variabilidad natural y datos incompletos â€” incluso el sistema climÃ¡tico siguiÃ³ acumulando calor.",
        fuentes: ["Wikipedia"] },
      { id: 6,  titulo: "Se avecina una nueva era de hielo (fue predicha en los aÃ±os 70)",
        texto: "SÃ­ hubo algunos estudios que especularon sobre enfriamiento, pero la gran mayorÃ­a ya vaticinaba calentamiento, y los modelos actuales han demostrado ser bastante fiables.",
        fuentes: ["#ThinkLandscape"] },
      { id: 7,  titulo: "AntÃ¡rtida estÃ¡ ganando hielo, no perdiendo",
        texto: "Aunque algunas partes (como la AntÃ¡rtida oriental) acumulan mÃ¡s nieve, en conjunto el continente pierde mÃ¡s masa por fusiÃ³n en otras zonas, contribuyendo al aumento del nivel del mar.",
        fuentes: ["#ThinkLandscape"] },
      { id: 8,  titulo: "El Sol es el culpable del calentamiento, no los humanos",
        texto: "Las observaciones muestran que la radiaciÃ³n solar y la temperatura global han divergido en las Ãºltimas tres dÃ©cadas, mientras los gases de efecto invernadero sÃ­ muestran correlaciÃ³n directa con el calentamiento.",
        fuentes: ["Skeptical Science"] },
      { id: 9,  titulo: "El grÃ¡fico 'hockey stick' es falso / los registros de temperatura son dudosos",
        texto: "Muchos argumentos atacan la validez de los registros histÃ³ricos, pero las series de temperatura, incluso desde zonas rurales o con termÃ³metros tradicionales, confirman la tendencia al alza, y los estudios que critican el 'hockey stick' carecen de respaldo robusto.",
        fuentes: ["Skeptical Science"] },
      { id: 10, titulo: "Radioactividad, rayos cÃ³smicos o procesos naturales explican todo",
        texto: "Argumentos que desvÃ­an el foco cientÃ­fico hacia procesos como rayos cÃ³smicos o efectos naturales han sido desmentidos: no hay correlaciÃ³n significativa con el calentamiento actual, mientras el COâ‚‚ antropogÃ©nico sÃ­ es el principal factor.",
        fuentes: [] }
    ];

    // ===========================
    // Utilidades
    // ===========================
    const $ = (q, el = document) => el.querySelector(q);
    const $$ = (q, el = document) => Array.from(el.querySelectorAll(q));
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const rand = (min, max) => Math.random() * (max - min) + min;

    // ===========================
    // Elementos principales
    // ===========================
    const root = document.getElementById('game-root');
    const area = document.getElementById('gameArea');
    const playerEl = document.getElementById('player');
    const butterfliesEl = document.getElementById('butterflies');
    const seenCountEl = document.getElementById('seenCount');
    const btnRestart = document.getElementById('btnRestart');

    // Modal
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalText = document.getElementById('modalText');
    const modalSources = document.getElementById('modalSources');
    const modalOk = document.getElementById('modalOk');
    const closeX = document.getElementById('closeX');
    const overlay = document.getElementById('overlay');

    // Fin
    const endScreen = document.getElementById('endScreen');
    const playAgain = document.getElementById('playAgain');

    // Controles tÃ¡ctiles
    const joystick = document.getElementById('joystick');
    const stick = document.getElementById('stick');
    const dpadButtons = $$('.dpad button');

    // ===========================
    // Estado de juego
    // ===========================
    const STATE = {
      w: 0, h: 0,
      running: true,
      lastT: 0,
      speed: 260, // px/s jugador
      player: { x: 200, y: 200, r: 24 },
      keys: { up:false, down:false, left:false, right:false },
      joy: { active:false, dx:0, dy:0, baseX:0, baseY:0, max:40 },
      butterflies: [],
      mapping: [],
      seenIds: new Set(),
      total: BULOS.length,
      facing: 'right' // 'right' | 'left' (orientaciÃ³n del cazador)
    };

    function resize() {
      const rect = area.getBoundingClientRect();
      STATE.w = rect.width;
      STATE.h = rect.height;
      STATE.player.x = clamp(STATE.player.x, STATE.player.r, STATE.w - STATE.player.r);
      STATE.player.y = clamp(STATE.player.y, STATE.player.r, STATE.h - STATE.player.r);
    }
    window.addEventListener('resize', resize, { passive: true });

    // ===========================
    // Mariposas
    // ===========================
    function createButterflyElement(h, s = 70, l = 55) {
      const div = document.createElement('div');
      div.className = 'butterfly';
      div.setAttribute('role', 'img');
      div.setAttribute('aria-label', 'Mariposa');
      const color = `hsl(${h} ${s}% ${l}%)`;
      div.innerHTML = `
        <svg viewBox="0 0 120 90" aria-hidden="true">
          <rect x="55" y="35" width="10" height="20" rx="5" fill="#333"/>
          <circle cx="60" cy="32" r="6" fill="#333"/>
          <g class="wL">
            <path d="M60,40 C30,20 18,10 14,26 C10,42 28,55 44,58 C50,59 54,58 58,52 Z" fill="${color}" opacity="0.95"/>
          </g>
          <g class="wR">
            <path d="M60,40 C90,20 102,10 106,26 C110,42 92,55 76,58 C70,59 66,58 62,52 Z" fill="${color}" opacity="0.95"/>
          </g>
          <circle cx="45" cy="50" r="5" fill="rgba(255,255,255,.65)"/>
          <circle cx="75" cy="50" r="5" fill="rgba(255,255,255,.65)"/>
        </svg>
      `;
      return div;
    }

    function spawnButterflies() {
      butterfliesEl.innerHTML = '';
      STATE.butterflies = [];
      STATE.mapping = shuffle([...Array(BULOS.length).keys()]);
      const margin = 50;
      const placed = [];

      for (let i = 0; i < BULOS.length; i++) {
        const hue = Math.round((360 / BULOS.length) * i + rand(-10,10));
        const el = createButterflyElement(hue);
        butterfliesEl.appendChild(el);

        const b = {
          id: i,
          x: 0, y: 0,
          vx: rand(-70, 70),
          vy: rand(-70, 70),
          r: 18,
          el
        };

        // posiciÃ³n inicial no solapada
        let attempts = 0;
        do {
          b.x = rand(margin, STATE.w - margin);
          b.y = rand(margin, STATE.h - margin);
          attempts++;
          if (attempts > 500) break;
        } while (placed.some(p => dist2(p.x, p.y, b.x, b.y) < (p.r + b.r + 26) ** 2));

        placed.push({ x: b.x, y: b.y, r: b.r });
        STATE.butterflies.push(b);
        setPos(b.el, b.x, b.y);
      }
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ===========================
    // Movimiento y colisiones
    // ===========================
    function setPos(el, x, y) {
      // Flip horizontal SOLO al jugador si mira a la izquierda
      const flip = (el === playerEl && STATE.facing === 'left') ? ' scaleX(-1)' : '';
      el.style.transform = `translate(${x}px, ${y}px) translate(-50%,-50%)${flip}`;
    }
    function dist2(x1,y1,x2,y2){ const dx=x2-x1, dy=y2-y1; return dx*dx+dy*dy; }

    function update(dt) {
      if (!STATE.running) return;

      // DirecciÃ³n por teclado/joystick
      let dx = (STATE.keys.right?1:0) - (STATE.keys.left?1:0);
      let dy = (STATE.keys.down?1:0) - (STATE.keys.up?1:0);

      // Mezclar joystick tÃ¡ctil
      if (STATE.joy.active) {
        dx += STATE.joy.dx;
        dy += STATE.joy.dy;
      }

      // Decidir orientaciÃ³n SOLO si hay componente horizontal claro
      if (dx < -0.01)      STATE.facing = 'left';
      else if (dx > 0.01)  STATE.facing = 'right';
      // Si dx â‰ˆ 0, no cambiamos: arriba/abajo mantiene la Ãºltima.

      // Normalizar y mover
      if (dx !== 0 || dy !== 0) {
        const len = Math.hypot(dx, dy);
        dx /= len; dy /= len;
        STATE.player.x = clamp(STATE.player.x + dx * STATE.speed * dt, STATE.player.r, STATE.w - STATE.player.r);
        STATE.player.y = clamp(STATE.player.y + dy * STATE.speed * dt, STATE.player.r, STATE.h - STATE.player.r);
      }
      setPos(playerEl, STATE.player.x, STATE.player.y);

      // Mariposas
      for (const b of STATE.butterflies) {
        b.x += b.vx * dt;
        b.y += b.vy * dt;

        // rebote contra bordes
        if (b.x < b.r) { b.x = b.r; b.vx *= -1; }
        if (b.x > STATE.w - b.r) { b.x = STATE.w - b.r; b.vx *= -1; }
        if (b.y < b.r) { b.y = b.r; b.vy *= -1; }
        if (b.y > STATE.h - b.r) { b.y = STATE.h - b.r; b.vy *= -1; }

        setPos(b.el, b.x, b.y);
      }

      // Colisiones con jugador
      const pr = STATE.player.r;
      for (const b of [...STATE.butterflies]) {
        const rsum = pr + b.r;
        if (dist2(STATE.player.x, STATE.player.y, b.x, b.y) <= rsum * rsum) {
          captureButterfly(b);
        }
      }
    }

    function loop(t) {
      const now = t * 0.001;
      const dt = Math.min(0.033, now - (STATE.lastT || now));
      STATE.lastT = now;
      update(dt);
      requestAnimationFrame(loop);
    }

    // ===========================
    // Captura y modal
    // ===========================
    function captureButterfly(b) {
      if (!STATE.butterflies.includes(b)) return;

      const buloIndex = STATE.mapping[b.id];
      const data = BULOS[buloIndex];
      if (STATE.seenIds.has(data.id)) return;

      STATE.butterflies = STATE.butterflies.filter(x => x !== b);
      b.el.remove();

      STATE.seenIds.add(data.id);
      seenCountEl.textContent = STATE.seenIds.size.toString();

      openModal(data);
    }

    function openModal(data) {
      STATE.running = false;
      modalTitle.textContent = data.titulo;
      modalText.textContent = data.texto;
      modalSources.innerHTML = (data.fuentes && data.fuentes.length)
        ? '<strong>Fuentes:</strong> ' + data.fuentes.join(', ')
        : '<strong>Fuentes:</strong> â€”';
      modal.classList.remove('hidden');
      setTimeout(() => modalOk.focus(), 0);
    }

    function closeModal() {
      if (modal.classList.contains('hidden')) return;
      modal.classList.add('hidden');
      if (STATE.seenIds.size >= STATE.total) {
        showEnd();
      } else {
        STATE.running = true;
        root.focus();
      }
    }

    function showEnd() {
      endScreen.classList.remove('hidden');
      setTimeout(() => playAgain.focus(), 0);
    }
    function hideEnd() {
      endScreen.classList.add('hidden');
      root.focus();
    }

    // ===========================
    // Reinicio
    // ===========================
    function resetGame() {
      STATE.seenIds.clear();
      seenCountEl.textContent = '0';
      STATE.running = true;
      STATE.player.x = STATE.w * 0.5;
      STATE.player.y = STATE.h * 0.62;
      STATE.facing = 'right'; // orientaciÃ³n por defecto
      spawnButterflies();
      hideEnd();
      root.focus();
    }

    // ===========================
    // Eventos: teclado
    // ===========================
    function setKey(e, isDown) {
      switch (e.key) {
        case 'ArrowUp': case 'w': case 'W': STATE.keys.up = isDown; break;
        case 'ArrowDown': case 's': case 'S': STATE.keys.down = isDown; break;
        case 'ArrowLeft': case 'a': case 'A': STATE.keys.left = isDown; break;
        case 'ArrowRight': case 'd': case 'D': STATE.keys.right = isDown; break;
        case 'Escape':
          if (!modal.classList.contains('hidden')) { closeModal(); }
          else if (!endScreen.classList.contains('hidden')) { resetGame(); }
          break;
      }
    }
    root.addEventListener('keydown', (e) => {
      if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
      setKey(e, true);
    });
    root.addEventListener('keyup', (e) => setKey(e, false));

    // ===========================
    // Eventos: modal
    // ===========================
    overlay.addEventListener('click', closeModal);
    modalOk.addEventListener('click', closeModal);
    closeX.addEventListener('click', closeModal);
    modal.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
        const foci = [closeX, modalOk];
        const i = foci.indexOf(document.activeElement);
        let ni = e.shiftKey ? (i <= 0 ? foci.length - 1 : i - 1) : (i >= foci.length - 1 ? 0 : i + 1);
        foci[ni].focus();
        e.preventDefault();
      }
    });

    // ===========================
    // Botones UI
    // ===========================
    btnRestart.addEventListener('click', resetGame);
    playAgain.addEventListener('click', resetGame);

    // ===========================
    // Controles tÃ¡ctiles: joystick y dpad
    // ===========================
    function joyStart(ev) {
      ev.preventDefault();
      STATE.joy.active = true;
      const r = joystick.getBoundingClientRect();
      STATE.joy.baseX = r.left + r.width / 2;
      STATE.joy.baseY = r.top + r.height / 2;
      joyMove(ev);
    }
    function joyMove(ev) {
      if (!STATE.joy.active) return;
      const p = getPoint(ev);
      const dx = p.x - STATE.joy.baseX;
      const dy = p.y - STATE.joy.baseY;
      const len = Math.hypot(dx, dy);
      const max = STATE.joy.max;
      const k = len > max ? (max / len) : 1;
      const sx = dx * k, sy = dy * k;
      stick.style.transform = `translate(${sx}px, ${sy}px) translate(-50%,-50%)`;
      STATE.joy.dx = (len < 6) ? 0 : (dx / (max));
      STATE.joy.dy = (len < 6) ? 0 : (dy / (max));
    }
    function joyEnd() {
      STATE.joy.active = false;
      STATE.joy.dx = 0; STATE.joy.dy = 0;
      stick.style.transform = `translate(-50%,-50%)`;
    }
    function getPoint(ev) {
      if (ev.touches && ev.touches[0]) return { x: ev.touches[0].clientX, y: ev.touches[0].clientY };
      return { x: ev.clientX, y: ev.clientY };
    }
    joystick.addEventListener('pointerdown', joyStart);
    window.addEventListener('pointermove', joyMove);
    window.addEventListener('pointerup', joyEnd);
    joystick.addEventListener('touchstart', joyStart, { passive: false });
    window.addEventListener('touchmove', joyMove, { passive: false });
    window.addEventListener('touchend', joyEnd);

    function dpadPress(dir, down) {
      if (down) {
        if (dir==='up') STATE.keys.up = true;
        if (dir==='down') STATE.keys.down = true;
        if (dir==='left') STATE.keys.left = true;
        if (dir==='right') STATE.keys.right = true;
      } else {
        if (dir==='up') STATE.keys.up = false;
        if (dir==='down') STATE.keys.down = false;
        if (dir==='left') STATE.keys.left = false;
        if (dir==='right') STATE.keys.right = false;
      }
    }
    $$('.dpad button').forEach(btn => {
      const dir = btn.dataset.dir;
      const downEv = (e) => { e.preventDefault(); dpadPress(dir, true); };
      const upEv = (e) => { e.preventDefault(); dpadPress(dir, false); };
      btn.addEventListener('pointerdown', downEv);
      btn.addEventListener('pointerup', upEv);
      btn.addEventListener('pointerleave', upEv);
      btn.addEventListener('touchstart', downEv, { passive:false });
      btn.addEventListener('touchend', upEv);
      btn.addEventListener('touchcancel', upEv);
    });

    // ===========================
    // Inicio
    // ===========================
    function init() {
      resize();
      STATE.player.x = STATE.w * 0.5;
      STATE.player.y = STATE.h * 0.62;
      STATE.facing = 'right';
      setPos(playerEl, STATE.player.x, STATE.player.y);
      spawnButterflies();
      root.focus();
      requestAnimationFrame(loop);
    }
    window.addEventListener('load', init);

    // Utilidad local
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
  </script>

  <noscript>
    <div style="position:fixed; inset:0; display:grid; place-items:center; background:#001b2e; color:#fff; z-index:9999; padding:24px; text-align:center;">
      <div>
        <h2 style="margin:0 0 8px;">Este juego necesita JavaScript</h2>
        <p style="opacity:.9; max-width:680px;">
          Si lo incrustas en un bloque HTML de WordPress.com y no se ve,
          usa un iframe desde un hosting externo o un mÃ©todo que permita ejecutar JS.
        </p>
      </div>
    </div>
  </noscript>
</body>
</html>
